#include "HX711.h"

// FSR í•€ë“¤
#define FSR1 A0
#define FSR2 A1
#define FSR3 A2
#define FSR4 A3  // ì„ íƒì  ì‚¬ìš©

// HX711 ë¡œë“œì…€ í•€ë“¤
#define LOADCELL_DOUT1 4
#define LOADCELL_SCK1 5
#define LOADCELL_DOUT2 6
#define LOADCELL_SCK2 7

HX711 scale1;
HX711 scale2;

int stepCount = 0;
bool isStepActive = false;

// ì„ê³„ê°’
const int fsrThreshold = 100;           // FSR ì•„ë‚ ë¡œê·¸ ì…ë ¥ ê¸°ì¤€
const long loadcellThreshold = 1000;    // HX711 ë‹¨ìœ„ ê¸°ì¤€

void setup() {
  Serial.begin(115200);

  // HX711 ì´ˆê¸°í™”
  scale1.begin(LOADCELL_DOUT1, LOADCELL_SCK1);
  scale2.begin(LOADCELL_DOUT2, LOADCELL_SCK2);

  scale1.set_scale();
  scale1.tare();
  scale2.set_scale();
  scale2.tare();

  Serial.println("ğŸ¥¿ ìŠ¤ë§ˆíŠ¸ ì¸ì†” - ê±¸ìŒ ì¸¡ì • ì‹œì‘");
}

void loop() {
  // FSR ê°’ ì½ê¸°
  int fsr1 = analogRead(FSR1);
  int fsr2 = analogRead(FSR2);
  int fsr3 = analogRead(FSR3);
  int fsr4 = analogRead(FSR4); // ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ ì œê±° ê°€ëŠ¥

  // ë¡œë“œì…€ ê°’ ì½ê¸°
  long load1 = scale1.get_units();
  long load2 = scale2.get_units();

  // ë””ë²„ê¹… ì¶œë ¥
  Serial.print("FSRs: ");
  Serial.print(fsr1); Serial.print(" ");
  Serial.print(fsr2); Serial.print(" ");
  Serial.print(fsr3); Serial.print(" ");
  Serial.print(fsr4); Serial.print(" | ");
  Serial.print("Loads: ");
  Serial.print(load1); Serial.print(" ");
  Serial.print(load2); Serial.print(" | ");
  Serial.print("Steps: "); Serial.println(stepCount);

  // ì„¼ì„œ ì¤‘ í•˜ë‚˜ë¼ë„ ë°Ÿí˜”ëŠ”ì§€ í™•ì¸
  bool fsrPressed = (fsr1 > fsrThreshold) || (fsr2 > fsrThreshold) ||
                    (fsr3 > fsrThreshold) || (fsr4 > fsrThreshold);
  bool loadcellPressed = (load1 > loadcellThreshold) || (load2 > loadcellThreshold);

  bool anySensorPressed = fsrPressed || loadcellPressed;

  // ê±¸ìŒ ì¸ì‹: ì„¼ì„œ ë°Ÿí˜ & ì´ì „ì— ë°Ÿì€ ìƒíƒœê°€ ì•„ë‹˜
  if (anySensorPressed && !isStepActive) {
    stepCount++;
    isStepActive = true;

    if (stepCount % 100 == 0) {
      Serial.print("ğŸ‰ 100ê±¸ìŒ ëŒíŒŒ! í˜„ì¬ ê±¸ìŒ ìˆ˜: ");
      Serial.println(stepCount);
    }
  }

  // ë°œì´ ë–¨ì–´ì§„ ê²½ìš° â†’ ë‹¤ì‹œ ê±¸ìŒ ì¸ì‹ ê°€ëŠ¥í•˜ê²Œ
  if (!anySensorPressed) {
    isStepActive = false;
  }

  delay(50); // ì•ˆì •ì„± í™•ë³´ë¥¼ ìœ„í•œ ì§§ì€ ë”œë ˆì´
}
